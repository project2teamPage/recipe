<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
</head>
<body>
<div>
  <div>
  <button type="button" onclick="location.href='/admin/noticeWrite'">작성하기</button>
      <form id="pinForm" method="post" action="/admin/notice/togglePinnedMultiple" style="display:inline;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <input type="hidden" id="noticeIdsInput" name="noticeIds"/>
          <button type="submit">고정/해제</button>
  </div>
    <table>
        <thead>
        <tr>
            <th></th>
            <th></th>
            <th>제목</th>
            <th>작성자</th>
            <th>작성일</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="notice : ${pinnedNotices}">
            <td>
                <input type="checkbox" name="noticeId" th:value="${notice.id}">
            </td>
            <td>[고정]</td>
            <td>
                <a th:href="'/admin/noticeDetail/' + ${notice.id}"
                   th:text="${notice.title}"></a>
            </td>
            <td th:text="${notice.adminNickName}"></td>
            <td th:text="${notice.writeDate}"></td>
        </tr>
        </tbody>
    </table>
    <table>
        <thead>
        <tr>
            <th></th>
            <th></th>
            <th>제목</th>
            <th>작성자</th>
            <th>작성일</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="noticeColumn : ${noticeList}">
            <td>
                <input type="checkbox" name="noticeId" th:value="${noticeColumn.id}">
            </td>
            <td th:text="${noticeColumn.pinned ? '[고정]' : ''}"></td>
            <td>
                <a th:href="'/admin/noticeDetail/' + ${noticeColumn.id}"
                   th:text="${noticeColumn.title}"></a>
            </td>
            <td th:text="${noticeColumn.adminNickName}"></td>
            <td th:text="${noticeColumn.writeDate}"></td>
        </tr>
        </tbody>
    </table>
    </form>
</div>
<script th:inline="javascript">
    const maxPinned = 4;
    const currentPinnedCount = [[${pinnedNotices.size()}]];

    document.getElementById('pinForm').addEventListener('submit', function (e) {
        const checked = document.querySelectorAll('input[name="noticeId"]:checked');

        if (checked.length === 0) {
            alert("선택된 공지사항이 없습니다.");
            e.preventDefault();
            return;
        }

        // 이미 고정된 공지가 4개인 상태에서 추가하려고 할 경우
        if (currentPinnedCount >= maxPinned) {
            const tryingToPinMore = Array.from(checked).some(cb => {
                const row = cb.closest('tr');
                const isPinned = row.querySelector('td:nth-child(2)').innerText.includes("고정");
                return !isPinned; // 고정이 아닌 걸 선택한 경우 = 고정을 시도하는 것
            });

            if (tryingToPinMore) {
                alert("고정 공지는 최대 4개까지 가능합니다.");
                e.preventDefault();
                return;
            }
        }

        // 여러 개 체크된 상태면 제한
        if (checked.length > 1) {
            alert("고정 또는 해제는 한 번에 하나만 선택해주세요.");
            e.preventDefault();
            return;
        }

        // 선택된 ID 전송
        const ids = Array.from(checked).map(cb => cb.value).join(',');
        document.getElementById('noticeIdsInput').value = ids;
    });
</script>
</body>
</html>